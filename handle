#!/bin/bash

PROCS=$(nproc)
CONTAINER_NAME="5gsniffer-cnt"

while [[ $# -gt 0 ]]; do
  case $1 in
  --build)
    BUILD=true
    shift
    ;;
  --run)
    RUN=true
    shift
    ;;
  --procs)
    PROCS="$2"
    shift 2
    ;;
  *)
    echo "Unknown option $1"
    exit 1
    ;;
  esac
done

if [ "$BUILD" == "true" ]; then
  PROC=$PROCS docker compose build
fi

if [ "$RUN" == "true" ]; then
  PROC=$PROCS docker compose up -d --build

  echo ""
  echo "[INFO] Containers started. Attaching interactive shell to sniffer (Ctrl+D or exit to detach)."
  docker compose exec sniffer /bin/bash

  echo ""
  echo "[INFO] Stopping compose services..."
  docker compose down --remove-orphans
fi

if [ "$BUILD" != "true" ] && [ "$RUN" != "true" ]; then
  echo "Usage: $0 [--build|--run] [--procs NUMBER]"
  echo "  --build: Build the Docker image"
  echo "  --run:   Run the Docker container"
  echo "  --procs: Specify number of processors (default: MAX)"
  exit 1
fi
